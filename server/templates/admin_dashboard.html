<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการไซโล - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-top">
            <div class="logo">
                <i class="fas fa-warehouse"></i>
                <span>ระบบจัดการไซโล</span>
            </div>
            <div class="user-info">
                <div class="user-details">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=F97316&color=fff" alt="User">
                    <span>ผู้ดูแลระบบ</span>
                </div>
                <a href="/logout" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>ออกจากระบบ</span>
                </a>
            </div>
        </div>
        
        <nav class="main-nav">
            <div class="nav-container">
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="/overview" class="nav-link">
                            <i class="fas fa-chart-pie"></i>
                            <span>ภาพรวมระบบ</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/dashboard" class="nav-link active">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>แดชบอร์ด</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/users" class="nav-link">
                            <i class="fas fa-users"></i>
                            <span>จัดการผู้ใช้</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/silos" class="nav-link">
                            <i class="fas fa-warehouse"></i>
                            <span>จัดการไซโล</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div style="text-align: center;">
            <div class="spinner"></div>
            <div>กำลังโหลดข้อมูล...</div>
        </div>
    </div>

    <!-- Main Content -->
    <main>
        <!-- Sidebar ทางซ้าย -->
        <aside id="branches">
            <div class="branches-header">
                <h2><i class="fas fa-map-marker-alt"></i>เลือกสาขา</h2>
                <button class="add-branch-btn" onclick="openAddBranchModal()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div id="branch-list" class="branch-list">
                <div style="text-align: center; padding: 2rem; color: var(--dark);">
                    <div class="loading"></div>
                    <div>กำลังโหลดสาขา...</div>
                </div>
            </div>
        </aside>

        <!-- เนื้อหาหลักทางขวา -->
        <section id="silos">
            <div class="section-header">
                <h2><i class="fas fa-warehouse"></i>ไซโลในสาขา</h2>
                <div class="section-actions">
                    <button class="action-btn" onclick="openUserManagement()">
                        <i class="fas fa-users-cog"></i> จัดการผู้ใช้
                    </button>
                    <button class="action-btn" onclick="openBranchManagement()">
                        <i class="fas fa-map-marker-alt"></i> จัดการสาขา
                    </button>
                    <button class="action-btn" onclick="openAddSiloModal()">
                        <i class="fas fa-plus"></i> เพิ่มไซโล
                    </button>
                    <button class="action-btn export-btn" onclick="openExportModal()">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                </div>
            </div>
            
            <!-- Branch Info -->
            <div class="branch-info">
                <i class="fas fa-info-circle"></i>
                <div class="branch-details">
                    <h3 id="current-branch-name">กำลังโหลด...</h3>
                    <p id="current-branch-location">กำลังโหลด...</p>
                </div>
            </div>

            <!-- Summary Statistics -->
            <div class="branch-summary" id="branch-summary">
                <div class="summary-card">
                    <h4>ทั้งหมด</h4>
                    <div class="value" id="total-silos">0</div>
                    <small>ไซโล</small>
                </div>
                <div class="summary-card">
                    <h4>กำลังใช้งาน</h4>
                    <div class="value" id="active-silos">0</div>
                    <small>ไซโล</small>
                </div>
                <div class="summary-card alert" id="low-capacity-card" style="display: none;">
                    <h4>ปริมาณต่ำ</h4>
                    <div class="value" id="low-capacity-silos">0</div>
                    <small>ต่ำกว่า 35%</small>
                </div>
                <div class="summary-card">
                    <h4>ใช้ไปแล้ว</h4>
                    <div class="value" id="total-used">0%</div>
                    <small>จากความจุทั้งหมด</small>
                </div>
            </div>

            <!-- Silo Grid -->
            <div id="silo-grid" class="silo-grid">
                <div style="text-align: center; padding: 2rem; color: var(--dark); width: 100%;">
                    <div class="loading"></div>
                    <div>กำลังโหลดไซโล...</div>
                </div>
            </div>

            <!-- Combined Chart Section -->
            <div class="chart-section">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-line"></i>กราฟปริมาณไซโล</h3>
                    <div class="chart-controls">
                        <div class="view-toggle">
                            <button class="view-option active" onclick="changeViewType('chart')">กราฟ</button>
                            <button class="view-option" onclick="changeViewType('table')">ตาราง</button>
                        </div>
                        <button class="chart-select-btn" onclick="openSiloSelection()">
                            <i class="fas fa-check-circle"></i> เลือกไซโล
                        </button>
                    </div>
                </div>
                <div id="chart-view">
                    <div class="chart-container">
                        <canvas id="combined-chart"></canvas>
                    </div>
                </div>
                <div id="table-view" style="display: none;">
                    <div class="table-container" id="data-table">
                        <div style="text-align: center; padding: 2rem; color: var(--dark);">
                            <div class="loading"></div>
                            <div>กำลังโหลดข้อมูลตาราง...</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Silo Detail Modal -->
    <div class="silo-detail-modal" id="siloDetailModal">
        <div class="silo-detail-content">
            <div class="silo-detail-header">
                <h3><i class="fas fa-info-circle"></i>รายละเอียดไซโล</h3>
                <button class="close-detail" onclick="closeSiloDetail()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="silo-detail-body">
                <div class="silo-detail-info">
                    <div class="silo-detail-item">
                        <span class="silo-detail-label">ชื่อไซโล:</span>
                        <span class="silo-detail-value" id="detail-name">-</span>
                    </div>
                    <div class="silo-detail-item">
                        <span class="silo-detail-label">วัสดุ:</span>
                        <span class="silo-detail-value" id="detail-material">-</span>
                    </div>
                    <div class="silo-detail-item">
                        <span class="silo-detail-label">ความจุทั้งหมด:</span>
                        <span class="silo-detail-value" id="detail-capacity">-</span>
                    </div>
                    <div class="silo-detail-item">
                        <span class="silo-detail-label">ปริมาณปัจจุบัน:</span>
                        <span class="silo-detail-value" id="detail-current">-</span>
                    </div>
                    <div class="silo-detail-item">
                        <span class="silo-detail-label">อัตราการใช้:</span>
                        <span class="silo-detail-value" id="detail-percentage">-</span>
                    </div>
                    <div class="silo-detail-item">
                        <span class="silo-detail-label">อัพเดตล่าสุด:</span>
                        <span class="silo-detail-value" id="detail-lastUpdated">-</span>
                    </div>
                </div>
                <div class="silo-detail-chart">
                    <canvas id="silo-detail-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Silo Selection Modal -->
    <div class="modal-overlay" id="siloSelectionModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-filter"></i> เลือกไซโลที่ต้องการแสดง</h3>
                <button class="close-modal" onclick="closeSiloSelection()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="silo-selection-list" id="siloSelectionList">
                    <div style="text-align: center; padding: 1rem; color: var(--dark);">
                        <div class="loading"></div>
                        <div>กำลังโหลดไซโล...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="selectAllSilos()">เลือกทั้งหมด</button>
                <button class="btn btn-secondary" onclick="deselectAllSilos()">ยกเลิกทั้งหมด</button>
                <button class="btn btn-primary" onclick="applySiloSelection()">ตกลง</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-file-excel"></i> Export Excel</h3>
                <button class="close-modal" onclick="closeExportModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="exportType">เลือกประเภทข้อมูล</label>
                    <select id="exportType" class="form-control">
                        <option value="daily">รายวัน</option>
                        <option value="hourly">รายชั่วโมง</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>เลือกไซโลที่ต้องการ Export</label>
                    <div class="silo-selection-list" id="exportSiloList">
                        <div style="text-align: center; padding: 1rem; color: var(--dark);">
                            <div class="loading"></div>
                            <div>กำลังโหลดไซโล...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeExportModal()">ยกเลิก</button>
                <button class="btn btn-primary" onclick="exportToExcel()">Export</button>
            </div>
        </div>
    </div>

    <!-- Add Silo Modal -->
    <div class="modal-overlay" id="addSiloModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-plus"></i> เพิ่มไซโลใหม่</h3>
                <button class="close-modal" onclick="closeAddSiloModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addSiloForm">
                    <div class="form-group">
                        <label for="siloDeviceId">Device ID *</label>
                        <input type="text" id="siloDeviceId" class="form-control" placeholder="เช่น SILO001" required>
                    </div>
                    <div class="form-group">
                        <label for="siloPlantType">ประเภทพืช *</label>
                        <input type="text" id="siloPlantType" class="form-control" placeholder="เช่น ข้าวสาร, ข้าวโพด" required>
                    </div>
                    <div class="form-group">
                        <label for="siloProvince">จังหวัด *</label>
                        <input type="text" id="siloProvince" class="form-control" placeholder="เช่น กรุงเทพ, ชลบุรี" required>
                    </div>
                    <div class="form-group">
                        <label for="siloSiteCode">รหัสไซต์ *</label>
                        <input type="text" id="siloSiteCode" class="form-control" placeholder="เช่น BKK001" required>
                    </div>
                    <div class="form-group">
                        <label for="siloNo">หมายเลขไซโล *</label>
                        <input type="text" id="siloNo" class="form-control" placeholder="เช่น 1, 2, 3" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddSiloModal()">ยกเลิก</button>
                <button class="btn btn-primary" onclick="addNewSilo()">เพิ่มไซโล</button>
            </div>
        </div>
    </div>

    <!-- Add Branch Modal -->
    <div class="modal-overlay" id="addBranchModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-plus"></i> เพิ่มสาขาใหม่</h3>
                <button class="close-modal" onclick="closeAddBranchModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addBranchForm">
                    <div class="form-group">
                        <label for="branchName">ชื่อสาขา</label>
                        <input type="text" id="branchName" class="form-control" placeholder="เช่น สาขากรุงเทพ, สาขาชลบุรี" required>
                    </div>
                    <div class="form-group">
                        <label for="branchLocation">ที่ตั้ง</label>
                        <input type="text" id="branchLocation" class="form-control" placeholder="เช่น บางนา, ศรีราชา" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddBranchModal()">ยกเลิก</button>
                <button class="btn btn-primary" onclick="addNewBranch()">เพิ่มสาขา</button>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal-overlay" id="userManagementModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h3><i class="fas fa-users-cog"></i> จัดการผู้ใช้</h3>
                <button class="close-modal" onclick="closeUserManagement()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="section-header" style="margin-bottom: 1rem; padding: 0;">
                    <button class="action-btn" onclick="openAddUserModal()">
                        <i class="fas fa-user-plus"></i> เพิ่มผู้ใช้ใหม่
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="data-table" id="usersTable">
                        <thead>
                            <tr>
                                <th>ชื่อผู้ใช้</th>
                                <th>บทบาท</th>
                                <th>สาขาที่เข้าถึง</th>
                                <th>สร้างเมื่อ</th>
                                <th>การกระทำ</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 2rem;">
                                    <div class="loading"></div>
                                    <div>กำลังโหลดข้อมูลผู้ใช้...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div class="modal-overlay" id="userFormModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-user-edit"></i> <span id="userFormTitle">เพิ่มผู้ใช้ใหม่</span></h3>
                <button class="close-modal" onclick="closeUserForm()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="editUserId">
                    
                    <div class="form-group">
                        <label for="username">ชื่อผู้ใช้ *</label>
                        <input type="text" id="username" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">รหัสผ่าน <span id="passwordNote">*</span></label>
                        <input type="password" id="password" class="form-control" required>
                        <small class="form-text">รหัสผ่านต้องมีความยาวอย่างน้อย 6 ตัวอักษร</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="role">บทบาท *</label>
                        <select id="role" class="form-control" required onchange="toggleBranchSelection()">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>

                    <!-- Branch Selection (แสดงเฉพาะเมื่อเลือกบทบาทเป็น User) -->
                    <div class="form-group" id="branchSelectionGroup" style="display: none;">
                        <label for="userBranches">สาขาที่เข้าถึง *</label>
                        <div class="branch-selection-list" id="userBranchesList">
                            <div style="text-align: center; padding: 1rem; color: var(--dark);">
                                <div class="loading"></div>
                                <div>กำลังโหลดสาขา...</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUserForm()">ยกเลิก</button>
                <button class="btn btn-primary" onclick="saveUser()">บันทึก</button>
            </div>
        </div>
    </div>

    <!-- Branch Management Modal -->
    <div class="modal-overlay" id="branchManagementModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="fas fa-map-marker-alt"></i> จัดการสาขา</h3>
                <button class="close-modal" onclick="closeBranchManagement()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="section-header" style="margin-bottom: 1rem; padding: 0;">
                    <button class="action-btn" onclick="openAddBranchModal()">
                        <i class="fas fa-plus"></i> เพิ่มสาขาใหม่
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ชื่อสาขา</th>
                                <th>จำนวนไซโล</th>
                                <th>ผู้ใช้ที่เข้าถึง</th>
                                <th>สถานะ</th>
                                <th>การกระทำ</th>
                            </tr>
                        </thead>
                        <tbody id="branchManagementTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 2rem;">
                                    <div class="loading"></div>
                                    <div>กำลังโหลดข้อมูลสาขา...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBranchManagement()">ปิด</button>
            </div>
        </div>
    </div>

    <footer>
        <p>© 2025 Fibo_Silo Management System v1.0</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/admin_dashboard.js') }}"></script>
</body>
</html>